<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Maschinen-Check</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151923; --text:#ffffff; --muted:#9aa1b3;
    --green:#15803d; --blue:#1e3a8a; --orange:#f97316; --red:#b91c1c;
    --btn:#19c37d; --btn2:#4b5563; --border:#232838; --chip:#0e1420;
  }
  body.light{
    --bg:#f6f8fb; --panel:#ffffff; --text:#0f172a; --muted:#475569;
    --green:#16a34a; --blue:#1d4ed8; --orange:#f97316; --red:#dc2626;
    --btn:#16a34a; --btn2:#64748b; --border:#e5e7eb; --chip:#f1f5f9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
  header{background:#151923;border-bottom:1px solid var(--border);padding:12px;position:sticky;top:0;z-index:10}
  body.light header{background:var(--panel)}
  h1{margin:0 0 6px 0;font-size:18px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .toolbar{margin-left:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .label{font-size:12px;color:var(--muted)}
  .total,.shiftInfo{color:var(--muted);font-size:13px}
  .extraLine{color:var(--muted);font-size:12px;margin-top:4px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--border);padding:4px 8px;border-radius:999px}
  main{padding:12px;max-width:920px;margin:0 auto}
  .btn{width:100%;padding:10px;border:none;border-radius:8px;background:var(--btn);color:white;font-weight:600;cursor:pointer}
  .btn2{background:var(--btn2);color:white;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px}
  .btnYellow{background:#f59e0b;color:#111;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px}
  .danger{background:#7f1d1d}
  .list{margin-top:10px}
  .task{padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid var(--border);position:relative;overflow:hidden}
  .task.red{background:var(--red)}
  .task.orange{background:var(--orange)}
  .task.blue{background:var(--blue)}
  .task.green{background:var(--green)}
  .task.paused{background:#f59e0b !important;border-color:#8b5cf6 !important;box-shadow:0 0 0 2px #8b5cf6 inset}
  @keyframes softBlink{0%{filter:brightness(1)}50%{filter:brightness(1.15)}100%{filter:brightness(1)}}
  .task.red.blink{animation:softBlink 1.2s ease-in-out infinite}
  .row{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
  .note{color:#eef;opacity:.9} body.light .note{color:#0f172a;opacity:.7}
  .pill{padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.25);font-variant-numeric:tabular-nums;font-weight:700}
  body.light .pill{background:#e2e8f0}
  .small{font-size:12px;color:#e8e8e8;opacity:.85} body.light .small{color:#334155;opacity:.9}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{background:rgba(0,0,0,.25);padding:2px 8px;border-radius:999px;font-size:12px}
  body.light .tag{background:#e2e8f0}
  .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .progress{height:6px;border-radius:999px;background:rgba(0,0,0,.25);overflow:hidden;margin-top:8px}
  .progress > span{display:block;height:100%;background:rgba(255,255,255,.8);width:0%}
  input:not([type="checkbox"]), select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0e1420;color:#e9ecf1}
  body.light input:not([type="checkbox"]), body.light select{background:#fff;color:#0f172a;border-color:#cbd5e1}
  dialog{border:none;border-radius:12px;padding:0;max-width:620px;width:92%}
  .dlg{padding:14px;background:#151923;color:#fff;border:1px solid var(--border);border-radius:12px}
  body.light .dlg{background:#ffffff;color:#0f172a}
  .dlg h3{margin:0 0 8px 0}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:620px){ .grid{grid-template-columns:1fr 1fr} }
  .checks{display:flex;gap:8px;flex-wrap:wrap}
  .checks label{display:flex;align-items:center;gap:8px;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border); background:#0e1420; color:#e9ecf1}
  body.light .checks label{background:#f8fafc;color:#0f172a;border-color:#cbd5e1}
  .calcRow{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;margin-top:4px}
  .manageHead{display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:6px;color:var(--muted);font-size:12px}
  .manageRow{display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:6px}
  .grpHead{display:grid;grid-template-columns:1fr 110px 90px;gap:10px;margin-bottom:6px;color:var(--muted);font-size:12px}
  .grpRow{display:grid;grid-template-columns:1fr 110px 90px;gap:10px;margin-bottom:6px}
  .hi{outline:2px solid #8b5cf6;border-radius:8px}
  .badge{margin-left:6px;font-size:11px;padding:2px 6px;border-radius:999px;background:rgba(0,0,0,.25)}
  body.light .badge{background:#e2e8f0}

  /* Blinkender roter Text f√ºr f√§llige Sichtpr√ºfung */
  .blinkText{
    color:#ff5a5a !important;
    animation: blinkText 1s ease-in-out infinite;
    border-color:#ff5a5a !important;
  }
  @keyframes blinkText{
    0%{opacity:1}
    50%{opacity:0.35}
    100%{opacity:1}
  }
</style>
</head>
<body>
<header>
  <h1>
    Maschinen-Check
    <span class="toolbar">
      <button class="btn2" id="themeBtn">üåì Modus</button>
      <span class="label">Gruppe</span>
      <select id="groupSelect" class="btn2" style="background:transparent;border:1px solid var(--border)">
        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
      </select>
      <button class="btn2" id="manageGroupsBtn">Gruppen verwalten</button>
    </span>
  </h1>
  <div class="shiftInfo" id="shiftInfo"></div>
  <div class="total" id="totalTime">Gesamtzeit: 0 Min (offen)</div>
  <div class="extraLine"><span id="nextBreak" class="chip">Pause bis zur n√§chsten Arbeit: ‚Äî</span></div>
  <div class="extraLine">
    <span id="inspectionInfo" class="chip">Sichtpr√ºfung in: ‚Äî</span>
    <button class="btnYellow" id="inspectionBtn">Sichtpr√ºfung erledigt</button>
  </div>
  <div class="extraLine">
    <span id="statusCounts" class="chip">√úberf√§llig: 0 ¬∑ Bald f√§llig: 0 ¬∑ Offen: 0 ¬∑ Elektriker: 0 ¬∑ Schlosser: 0</span>
  </div>
</header>

<main>
  <button class="btn" id="addBtn">+ Maschine hinzuf√ºgen</button>
  <div class="actions" style="margin-top:8px">
    <button class="btn2" id="manageTasksBtn">‚öôÔ∏è Aufgaben verwalten</button>
  </div>
  <div class="list" id="taskList"></div>
  <button class="btn" id="pdfBtn">üìÑ PDF erstellen</button>
</main>

<!-- Dialog Maschine -->
<dialog id="taskDlg">
  <div class="dlg">
    <h3 id="dlgTitle">Maschine hinzuf√ºgen</h3>
    <div class="grid">
      <div>
        <label class="small">Maschinen-Nr. (aus Gruppe)</label>
        <select id="f_nr_select"></select>
      </div>
      <div>
        <label class="small">Restzeit (Std:Min) ‚Äì max 08:00</label>
        <input id="f_timer" type="time" step="60" value="00:30">
      </div>
      <div style="grid-column:1 / -1">
        <label class="small">Aufgaben</label>
        <div class="checks" id="checks">
          <label><input type="checkbox" class="f_tag" value="Fachung" data-min="10"> Fachung (10)</label>
          <label><input type="checkbox" class="f_tag" value="Folie" data-min="3"> Folie (3)</label>
          <label><input type="checkbox" class="f_tag" value="Einbau" data-min="5"> Einbau (5)</label>
          <label><input type="checkbox" class="f_tag" value="Ausbau" data-min="4"> Ausbau (4)</label>
          <label><input type="checkbox" class="f_tag" value="Maschinen putzen" data-min="15"> Maschinen putzen (15)</label>
        </div>
        <div class="calcRow"><span>Berechnete Arbeitszeit:</span><strong id="calcDur">0 Min</strong></div>
      </div>
      <div>
        <label class="small">Zusatz-Minuten</label>
        <input id="f_extra" type="number" min="0" step="1" value="0">
      </div>
      <div>
        <label class="small">Notiz</label>
        <input id="f_note" type="text" placeholder="Notizen f√ºr dich selbst">
      </div>
      <div style="grid-column:1 / -1">
        <label class="small">Fehler/Grund (optional)</label>
        <select id="f_reason">
          <option value="">‚Äî</option>
          <option value="Elektriker">Elektriker gemeldet (Defekt)</option>
          <option value="Schlosser">Schlosser gemeldet (Defekt)</option>
        </select>
      </div>
    </div>
    <div class="actions" style="margin-top:6px">
      <button class="btn2" id="cancelBtn">Abbrechen</button>
      <button class="btn2" id="saveBtn">Speichern</button>
    </div>
  </div>
</dialog>

<!-- Dialog Aufgaben verwalten -->
<dialog id="manageDlg">
  <div class="dlg">
    <h3>Aufgaben verwalten</h3>
    <div class="small" style="margin-bottom:6px">Aufgabe links, Minuten (1‚Äì60) rechts.</div>
    <div class="manageHead"><div>Aufgabe</div><div>Minuten</div></div>
    <div id="taskRows"></div>
    <div class="actions" style="margin-top:8px">
      <button class="btn2" id="addTaskTypeBtn">+ Aufgabe</button>
      <button class="btn2" id="resetTaskTypesBtn">‚Ü∫ Standard</button>
      <button class="btn2" id="closeManageBtn">Schlie√üen</button>
      <button class="btn2" id="saveManageBtn">Speichern</button>
    </div>
  </div>
</dialog>

<!-- Dialog Grund setzen (Buttons) -->
<dialog id="reasonDlg">
  <div class="dlg">
    <h3>Grund setzen</h3>
    <div class="actions" style="margin-top:4px">
      <button class="btn2" id="reasonEle">Elektriker</button>
      <button class="btn2" id="reasonSch">Schlosser</button>
      <button class="btn2" id="reasonClear">Entfernen</button>
      <button class="btn2" id="reasonCancel">Abbrechen</button>
    </div>
  </div>
</dialog>

<!-- Dialog Gruppen verwalten (Maschinen-Nr. <-> Gruppe) -->
<dialog id="groupDlg">
  <div class="dlg">
    <h3>Gruppen verwalten (Maschine ‚Üî Gruppe)</h3>
    <div class="small" style="margin-bottom:6px">Feste Zuordnung. Hier legst du alle Nummern an / korrigierst Tippfehler.</div>
    <div class="grpHead"><div>Maschinen-Nr.</div><div>Gruppe (1‚Äì4)</div><div>Aktion</div></div>
    <div id="groupRows"></div>
    <div class="actions" style="margin-top:8px">
      <button class="btn2" id="addGroupMapBtn">+ Zuordnung</button>
      <button class="btn2" id="closeGroupBtn">Schlie√üen</button>
      <button class="btn2" id="saveGroupBtn">Speichern</button>
    </div>
  </div>
</dialog>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* === Konstanten & Keys === */
const ORANGE_THRESHOLD_MIN = 45;
const MAX_TIMER_MIN = 8*60;
const INSPECTION_INTERVAL_MIN = 120;
const KEY = "maschinenCheck_v1plus";
const KEY_TASKTYPES = "maschinenCheck_taskTypes_v1";
const KEY_INSPECTION = "maschinenCheck_inspectionLastAt_v1";
const KEY_THEME = "maschinenCheck_theme_v1";
const KEY_GROUPMAP = "maschinenCheck_machineGroups_v1";
const KEY_CURRENT_GROUP = "maschinenCheck_currentGroup_v1";

/* === State === */
let tasks = JSON.parse(localStorage.getItem(KEY) || "[]");
let machineGroups = loadGroupMap(); // { "74":2, ... }

/* === Helpers === */
const $ = s => document.querySelector(s);
const $$ = (s,root=document) => Array.from(root.querySelectorAll(s));
function save(){ localStorage.setItem(KEY, JSON.stringify(tasks)); }
function saveGroupMap(){ localStorage.setItem(KEY_GROUPMAP, JSON.stringify(machineGroups)); }
function loadGroupMap(){ try{ return JSON.parse(localStorage.getItem(KEY_GROUPMAP) || "{}"); }catch(e){ return {}; } }
function fmtCountdown(ms){ if(ms<=0) return "00:00"; const t=Math.floor(ms/60000),h=Math.floor(t/60),m=t%60; return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`; }
function fmtTime(ts){ const d=new Date(ts),hh=String(d.getHours()).padStart(2,"0"),mm=String(d.getMinutes()).padStart(2,"0"); return `${hh}:${mm}`; }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function timeToMinutes(val){ if(!val||!val.includes(":")) return 0; const [h,m]=val.split(":").map(n=>parseInt(n,10)); return clamp(h*60+m,0,MAX_TIMER_MIN); }
function statusFor(t){
  if (t.done) return "green";
  if (t.reason === "Elektriker" || t.reason === "Schlosser") return "paused"; // Pause hat Vorrang
  const left = t.due - Date.now();
  if (left <= 0) return "red";
  if (left <= ORANGE_THRESHOLD_MIN*60000) return "orange";
  return "blue";
}
function sortTasks(a,b){
  const now = Date.now();
  const aOver = (!a.done && a.due <= now && !(a.reason));
  const bOver = (!b.done && b.due <= now && !(b.reason));
  if (aOver && !bOver) return -1;
  if (!aOver && bOver) return 1;
  if (!a.done && a.reason && (!b.done && !b.reason)) return -1;
  if ((!a.done && !a.reason) && (!b.done && b.reason)) return 1;
  if (!a.done && b.done) return -1;
  if (a.done && !b.done) return 1;
  return Math.max(0,a.due-now) - Math.max(0,b.due-now);
}

/* === Theme === */
(function initTheme(){
  const t = localStorage.getItem(KEY_THEME);
  if(t === "light") document.body.classList.add("light");
})();
$("#themeBtn").addEventListener("click", ()=>{
  document.body.classList.toggle("light");
  localStorage.setItem(KEY_THEME, document.body.classList.contains("light") ? "light" : "dark");
});

/* === Current Group Selector === */
(function initGroupSelect(){
  const cur = parseInt(localStorage.getItem(KEY_CURRENT_GROUP)||"1",10)||1;
  $("#groupSelect").value = String(cur);
})();
$("#groupSelect").addEventListener("change", ()=>{
  localStorage.setItem(KEY_CURRENT_GROUP, $("#groupSelect").value);
});

/* === Aufgaben-Typen === */
const DEFAULT_TASK_TYPES = [
  {label:"Fachung", minutes:10},
  {label:"Folie", minutes:3},
  {label:"Einbau", minutes:5},
  {label:"Ausbau", minutes:4},
  {label:"Maschinen putzen", minutes:15},
];
function loadTaskTypes(){ try{ return JSON.parse(localStorage.getItem(KEY_TASKTYPES)) || DEFAULT_TASK_TYPES.slice(); } catch(e){ return DEFAULT_TASK_TYPES.slice(); } }
function saveTaskTypes(list){ localStorage.setItem(KEY_TASKTYPES, JSON.stringify(list)); }
function rebuildChecksFromTypes(){
  const types = loadTaskTypes();
  const wrap = $("#checks"); wrap.innerHTML = "";
  types.forEach(t=>{
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" class="f_tag" value="${t.label}" data-min="${t.minutes}"> ${t.label} (${t.minutes})`;
    wrap.appendChild(label);
  });
}
rebuildChecksFromTypes();

/* === Sichtpr√ºfung === */
function getLastInspection(){ return parseInt(localStorage.getItem(KEY_INSPECTION)||"0",10) || 0; }
function setLastInspection(ts){ localStorage.setItem(KEY_INSPECTION, String(ts)); }
if(!getLastInspection()){ setLastInspection(Date.now()); }
$("#inspectionBtn").addEventListener("click", ()=>{ setLastInspection(Date.now()); render(); });

/* === Reason Dialog (Buttons) === */
let reasonTargetId = null;
const reasonDlg = $("#reasonDlg");
$("#reasonEle").addEventListener("click", ()=> applyReasonToTarget("Elektriker"));
$("#reasonSch").addEventListener("click", ()=> applyReasonToTarget("Schlosser"));
$("#reasonClear").addEventListener("click", ()=> applyReasonToTarget(""));
$("#reasonCancel").addEventListener("click", ()=> reasonDlg.close());
function openReasonDialog(id){ reasonTargetId = id; reasonDlg.showModal(); }
function applyReasonToTarget(val){
  if(reasonTargetId==null){ reasonDlg.close(); return; }
  const t = tasks.find(x=>x.id===reasonTargetId);
  if(t){ t.reason = (val||"").trim(); save(); render(); }
  reasonTargetId = null; reasonDlg.close();
}

/* === Gruppen Manager (Maschinen-Nummer ‚Üî Gruppe) === */
const groupDlg = $("#groupDlg");
$("#manageGroupsBtn").addEventListener("click", ()=>{ buildGroupRows(); groupDlg.showModal(); });
$("#closeGroupBtn").addEventListener("click", ()=> groupDlg.close());
$("#addGroupMapBtn").addEventListener("click", ()=>{
  const box = $("#groupRows");
  const row = document.createElement("div");
  row.className = "grpRow";
  row.innerHTML = `
    <div><input type="text" placeholder="z. B. 74" class="gm_nr"></div>
    <div>
      <select class="gm_group">
        <option>1</option><option>2</option><option>3</option><option>4</option>
      </select>
    </div>
    <div><button class="btn2 gm_del">L√∂schen</button></div>
  `;
  box.appendChild(row);
  row.querySelector(".gm_del").addEventListener("click", ()=>{ row.remove(); });
});
$("#saveGroupBtn").addEventListener("click", ()=>{
  const nrs = $$(".gm_nr", groupDlg).map(i=>i.value.trim()).filter(x=>x!=="");
  const gps = $$(".gm_group", groupDlg).map(i=>parseInt(i.value,10));
  const map = {};
  for(let i=0;i<nrs.length;i++){
    const k = nrs[i];
    if(!/^\d+$/.test(k)){ alert("Nur positive Nummern erlaubt."); return; }
    const g = gps[i]; if(!(g>=1 && g<=4)){ alert("Gruppe muss 1‚Äì4 sein."); return; }
    map[k] = g;
  }
  machineGroups = map;
  saveGroupMap();
  groupDlg.close();
  render();
});
function buildGroupRows(highlightNr=null){
  const box = $("#groupRows"); box.innerHTML = "";
  const entries = Object.keys(machineGroups).sort((a,b)=> parseInt(a,10)-parseInt(b,10));
  if(entries.length===0){ $("#addGroupMapBtn").click(); return; }
  entries.forEach(k=>{
    const g = machineGroups[k];
    const row = document.createElement("div");
    row.className = "grpRow" + (highlightNr && highlightNr===k ? " hi" : "");
    row.innerHTML = `
      <div><input type="text" value="${k}" class="gm_nr"></div>
      <div>
        <select class="gm_group">
          <option ${g===1?"selected":""}>1</option>
          <option ${g===2?"selected":""}>2</option>
          <option ${g===3?"selected":""}>3</option>
          <option ${g===4?"selected":""}>4</option>
        </select>
      </div>
      <div><button class="btn2 gm_del">L√∂schen</button></div>
    `;
    box.appendChild(row);
    row.querySelector(".gm_del").addEventListener("click", ()=>{
      row.remove();
    });
  });
}

/* === Render === */
function render(){
  const list = tasks.slice().sort(sortTasks);
  const total = list.filter(t=>!t.done).reduce((s,t)=> s + (parseInt(t.duration,10)||0), 0);
  $("#totalTime").textContent = `Gesamtzeit: ${total} Min (offen)`;
  $("#shiftInfo").textContent = getShiftInfo();

  const now = Date.now();
  const open = list.filter(t=>!t.done);
  const nextMs = open.map(t=>t.due - now).filter(ms=>ms>0).sort((a,b)=>a-b)[0];
  let pauseTxt = "‚Äî";
  if(open.length===0) pauseTxt = "‚Äî (keine anstehende Arbeit)";
  else if(nextMs===undefined){ pauseTxt = open.some(t=>t.due<=now && !t.reason) ? "00:00 (sofort)" : "‚Äî"; }
  else pauseTxt = fmtCountdown(nextMs);
  $("#nextBreak").textContent = `Pause bis zur n√§chsten Arbeit: ${pauseTxt}`;

  const last = getLastInspection();
  const dueIn = INSPECTION_INTERVAL_MIN*60000 - (now - last);
  const insp = $("#inspectionInfo");
  if(dueIn>0){
    insp.textContent = `Sichtpr√ºfung in: ${fmtCountdown(dueIn)}`;
    insp.classList.remove("blinkText");
  }else{
    insp.textContent = `Sichtpr√ºfung f√§llig!`;
    insp.classList.add("blinkText"); // roter, blinkender Text
  }

  const overCount = open.filter(t=>t.due <= now && !t.reason).length;
  const soonCount = open.filter(t=>t.due > now && (t.due - now) <= ORANGE_THRESHOLD_MIN*60000 && !t.reason).length;
  const openCount = open.length;
  const eleCount = open.filter(t=>t.reason==="Elektriker").length;
  const schCount = open.filter(t=>t.reason==="Schlosser").length;
  $("#statusCounts").textContent = `√úberf√§llig: ${overCount} ¬∑ Bald f√§llig: ${soonCount} ¬∑ Offen: ${openCount} ¬∑ Elektriker: ${eleCount} ¬∑ Schlosser: ${schCount}`;

  const box = $("#taskList"); box.innerHTML = "";
  list.forEach(t=>{
    const msLeft = t.due - now;
    const status = statusFor(t);
    const tags = (t.tags||[]).map(x=>`<span class="tag">${x}</span>`).join("");
    const reasonTag = t.reason ? `<span class="tag">Grund: ${t.reason}</span>` : "";
    const grpBadge = t.group ? `<span class="badge">G${t.group}</span>` : "";
    const div = document.createElement("div");
    div.className = `task ${status}`;
    if(status === "red") div.classList.add("blink");
    if(status === "paused"){ div.classList.remove("blink"); div.classList.add("paused"); }

    const totalMinInit = parseInt(t.totalMin || 0, 10);
    let progressPct = 0;
    if(totalMinInit > 0){
      const gone = clamp(totalMinInit*60000 - Math.max(0, msLeft), 0, totalMinInit*60000);
      progressPct = Math.round((gone / (totalMinInit*60000)) * 100);
    }

    const dueTimeTxt = fmtTime(t.due);
    div.innerHTML = `
      <div class="row">
        <strong>Maschine ${t.nr} ${grpBadge}</strong>
        <span class="pill">${fmtCountdown(Math.max(0,msLeft))} ¬∑ f√§llig um ${dueTimeTxt}</span>
      </div>
      <div class="tags">${tags}${reasonTag}</div>
      <div class="row" style="margin-top:6px">
        <span class="note">${t.note||""}</span>
        <span class="small">Arbeitszeit: ${t.duration||0} Min</span>
      </div>
      <div class="progress"><span style="width:${progressPct}%;"></span></div>
      <div class="actions">
        <button class="btn2" onclick="adjTime(${t.id}, -5)">‚àí5 Min</button>
        <button class="btn2" onclick="adjTime(${t.id}, +5)">+5 Min</button>
        <button class="btn2" onclick="toggleDone(${t.id})">${t.done ? "Wieder offen" : "Erledigt"}</button>
        <button class="btn2" onclick="editTask(${t.id})">Bearbeiten</button>
        <button class="btn2" onclick="openReasonDialog(${t.id})">Grund setzen</button>
        <button class="btn2 danger" onclick="deleteTask(${t.id})">L√∂schen</button>
      </div>
    `;
    box.appendChild(div);
  });
}

/* === Schichtinfo === */
function getShiftInfo(){
  const now = new Date(), h=now.getHours(), m=now.getMinutes(), min=h*60+m;
  if(min >= 330 && min < 810) return "Fr√ºhschicht 05:30-13:30";
  if(min >= 810 && min < 1290) return "Sp√§tschicht 13:30-21:30";
  return "Nachtschicht 21:30-05:30";
}

/* === CRUD === */
function addTask(){ openDialog(); }
function editTask(id){ const t = tasks.find(x=>x.id===id); if(!t) return; openDialog(t); }
function deleteTask(id){ if(!confirm("Eintrag l√∂schen?")) return; tasks = tasks.filter(t=>t.id!==id); save(); render(); }
function toggleDone(id){ const t = tasks.find(x=>x.id===id); if(!t) return; t.done = !t.done; save(); render(); }
function adjTime(id, deltaMin){ const t=tasks.find(x=>x.id===id); if(!t||t.done) return; t.due += deltaMin*60000; t.totalMin = clamp((t.totalMin||0)+deltaMin,0,MAX_TIMER_MIN); save(); render(); }

/* === Aufgaben verwalten === */
const manageDlg = $("#manageDlg");
$("#manageTasksBtn").addEventListener("click", ()=>{ buildManageRows(); manageDlg.showModal(); });
$("#closeManageBtn").addEventListener("click", ()=> manageDlg.close());
$("#resetTaskTypesBtn").addEventListener("click", ()=>{ saveTaskTypes(DEFAULT_TASK_TYPES.slice()); buildManageRows(); rebuildChecksFromTypes(); });
function minuteSelectHTML(value){ const v=parseInt(value,10)||5; let opts=""; for(let i=1;i<=60;i++){ opts+=`<option value="${i}" ${i===v?'selected':''}>${i}</option>`;} return `<select class="mt_minutes_select">${opts}</select>`; }
$("#addTaskTypeBtn").addEventListener("click", ()=>{ const box=$("#taskRows"); const row=document.createElement("div"); row.className="manageRow"; row.innerHTML=`<div><input type="text" placeholder="Bezeichnung" class="mt_label"></div><div>${minuteSelectHTML(5)}</div>`; box.appendChild(row); });
$("#saveManageBtn").addEventListener("click", ()=>{
  const labels = $$(".mt_label", manageDlg).map(i=>i.value.trim());
  const mins = $$(".mt_minutes_select", manageDlg).map(i=>parseInt(i.value,10)||0);
  const merged=[]; for(let i=0;i<labels.length;i++){ if(labels[i] && mins[i]>0){ merged.push({label:labels[i], minutes:mins[i]}); } }
  if(merged.length===0){ alert("Bitte mindestens eine g√ºltige Aufgabe anlegen."); return; }
  saveTaskTypes(merged); rebuildChecksFromTypes(); manageDlg.close();
});
function buildManageRows(){
  const box=$("#taskRows"); box.innerHTML=""; const types=loadTaskTypes();
  types.forEach(t=>{ const row=document.createElement("div"); row.className="manageRow"; row.innerHTML=`<div><input type="text" value="${t.label}" class="mt_label"></div><div>${minuteSelectHTML(t.minutes)}</div>`; box.appendChild(row); });
}

/* === Dialog Maschine === */
const dlg = $("#taskDlg");
$("#addBtn").addEventListener("click", addTask);
$("#cancelBtn").addEventListener("click", ()=> dlg.close());
$("#saveBtn").addEventListener("click", saveFromDialog);
function updateCalcDur(){ const base=$$(".f_tag:checked").reduce((s,el)=> s + (parseInt(el.dataset.min,10)||0), 0); const extra=parseInt($("#f_extra").value,10)||0; $("#calcDur").textContent = `${base+extra} Min`; }
document.addEventListener("change", e=>{ if(e.target.matches(".f_tag")) updateCalcDur(); });
$("#f_extra").addEventListener("input", updateCalcDur);

let editId = null;

/* Maschine-Select aus Mapping f√ºllen (gefiltert nach aktueller Gruppe) */
function fillMachineSelect(selectEl, preselectNr=null){
  const curGroup = parseInt(localStorage.getItem(KEY_CURRENT_GROUP)||"1",10)||1;
  const entries = Object.entries(machineGroups)
    .filter(([nr,g])=> g===curGroup)
    .sort((a,b)=> parseInt(a[0],10)-parseInt(b[0],10));

  selectEl.innerHTML = "";
  if(entries.length===0){
    const opt = document.createElement("option");
    opt.value=""; opt.textContent="(Keine Nummern in dieser Gruppe ‚Äì bitte in ‚ÄûGruppen verwalten‚Äú anlegen)";
    selectEl.appendChild(opt);
    selectEl.disabled = true;
  } else {
    entries.forEach(([nr])=>{
      const opt = document.createElement("option");
      opt.value = nr; opt.textContent = nr;
      selectEl.appendChild(opt);
    });
    selectEl.disabled = false;
    if(preselectNr && machineGroups[preselectNr]===curGroup){
      selectEl.value = String(preselectNr);
    }
  }
}

function openDialog(t=null){
  editId = t?.id ?? null;
  $("#dlgTitle").textContent = t ? "Maschine bearbeiten" : "Maschine hinzuf√ºgen";
  $("#f_note").value = t?.note ?? "";
  $("#f_extra").value = 0;
  rebuildChecksFromTypes();
  $$(".f_tag").forEach(cb=> cb.checked = !!(t?.tags||[]).includes(cb.value));

  // Maschinen-Select laden (nur aktuelle Gruppe)
  fillMachineSelect($("#f_nr_select"), t?.nr || null);

  if(t){
    const leftMin = Math.max(0, Math.floor((t.due - Date.now())/60000));
    const h = Math.floor(leftMin/60), m = leftMin%60;
    $("#f_timer").value = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
    $("#f_reason").value = t.reason || "";
  } else {
    $("#f_timer").value = "00:30";
    $("#f_reason").value = "";
  }
  updateCalcDur();
  dlg.showModal();
}

function saveFromDialog(){
  const nr = $("#f_nr_select").value;
  if(!nr){
    alert("Es sind keine Maschinen-Nummern in dieser Gruppe hinterlegt. Bitte zuerst in ‚ÄûGruppen verwalten‚Äú anlegen.");
    return;
  }
  const note = $("#f_note").value.trim();
  const timerMin = timeToMinutes($("#f_timer").value);
  const tagMins  = $$(".f_tag:checked").reduce((s,el)=> s + (parseInt(el.dataset.min,10)||0), 0);
  const extra    = parseInt($("#f_extra").value,10) || 0;
  const duration = tagMins + extra;
  const tags     = $$(".f_tag:checked").map(el=>el.value);
  const reason   = ($("#f_reason").value || "").trim();

  const grp = machineGroups[nr]; // feste, gespeicherte Gruppe
  if(!(grp>=1 && grp<=4)){
    alert("Diese Maschinen-Nummer hat keine g√ºltige Gruppen-Zuordnung. Bitte in ‚ÄûGruppen verwalten‚Äú pr√ºfen.");
    return;
  }

  const due = Date.now() + timerMin*60000;

  if(editId){
    const t = tasks.find(x=>x.id===editId);
    if(t){
      t.nr = nr; t.group = grp; t.note = note; t.duration = duration; t.due = due; t.tags = tags; t.reason = reason; t.totalMin = timerMin;
    }
  } else {
    tasks.push({ id: Date.now(), nr, group: grp, note, duration, due, done:false, tags, reason, totalMin: timerMin });
  }
  save(); render(); dlg.close();
}

/* === PDF === */
$("#pdfBtn").addEventListener("click", ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF(); doc.setFontSize(14);
  doc.text("Maschinen-Check Bericht", 10, 10);
  let y = 20;
  tasks.filter(t=>t.done).forEach(t=>{
    doc.text(`M${t.nr} (G${t.group||"-"}) - ${t.tags.join(", ")} - ${t.duration} Min`, 10, y);
    y += 8;
  });
  doc.save("maschinen_bericht.pdf");
});

/* === Start === */
render();
setInterval(render, 1000);
</script>
</body>
</html>
