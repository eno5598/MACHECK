<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Maschinen-Check</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151923; --text:#ffffff; --muted:#9aa1b3;
    --green:#15803d; --blue:#1e3a8a; --orange:#f97316; --red:#b91c1c;
    --btn:#19c37d; --btn2:#4b5563; --border:#232838;
    --chip:#0e1420;
  }
  /* Light-Mode */
  body.light{
    --bg:#f6f8fb; --panel:#ffffff; --text:#0f172a; --muted:#475569;
    --green:#16a34a; --blue:#1d4ed8; --orange:#f97316; --red:#dc2626;
    --btn:#16a34a; --btn2:#64748b; --border:#e5e7eb;
    --chip:#f1f5f9;
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
  header{background:#151923;border-bottom:1px solid var(--border);padding:12px;position:sticky;top:0;z-index:10}
  body.light header{background:var(--panel)}
  h1{margin:0 0 4px 0;font-size:18px}
  .total,.shiftInfo{color:var(--muted);font-size:13px}
  .extraLine{color:var(--muted);font-size:12px;margin-top:4px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--border);padding:4px 8px;border-radius:999px}
  .right{float:right}

  main{padding:12px;max-width:820px;margin:0 auto}
  .btn{width:100%;padding:10px;border:none;border-radius:8px;background:var(--btn);color:white;font-weight:600;cursor:pointer}
  .list{margin-top:10px}
  .task{padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid var(--border);position:relative;overflow:hidden}
  .task.red{background:var(--red)}
  .task.orange{background:var(--orange)}
  .task.blue{background:var(--blue)}
  .task.green{background:var(--green)}

  /* Fortschrittsbalken */
  .progress{height:6px;border-radius:999px;background:rgba(0,0,0,.25);overflow:hidden;margin-top:8px}
  .progress > span{display:block;height:100%;background:rgba(255,255,255,.8);width:0%}

  /* Blinken bei √úberf√§lligkeit */
  @keyframes softBlink {
    0% { filter:brightness(1); }
    50%{ filter:brightness(1.15); }
    100%{ filter:brightness(1); }
  }
  .task.red.blink { animation: softBlink 1.2s ease-in-out infinite; }

  /* Grund gesetzt -> gelb + lila Umrandung */
  .task.paused{
    background:#f59e0b !important;
    border-color:#8b5cf6 !important;
    box-shadow:0 0 0 2px #8b5cf6 inset;
  }

  .row{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
  .note{color:#eef;opacity:.9}
  body.light .note{color:#0f172a;opacity:.7}
  .pill{padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.25);font-variant-numeric:tabular-nums;font-weight:700}
  body.light .pill{background:#e2e8f0}
  .small{font-size:12px;color:#e8e8e8;opacity:.85}
  body.light .small{color:#334155;opacity:.9}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{background:rgba(0,0,0,.25);padding:2px 8px;border-radius:999px;font-size:12px}
  body.light .tag{background:#e2e8f0}
  .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .btn2{background:var(--btn2);color:white;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px}
  .btnYellow{background:#f59e0b;color:#111;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px}
  .danger{background:#7f1d1d}
  input:not([type="checkbox"]), select{
    width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);
    background:#0e1420;color:#e9ecf1
  }
  body.light input:not([type="checkbox"]), body.light select{
    background:#ffffff;color:#0f172a;border-color:#cbd5e1
  }
  dialog{border:none;border-radius:12px;padding:0;max-width:560px;width:92%}
  .dlg{padding:14px;background:#151923;color:#fff;border:1px solid var(--border);border-radius:12px}
  body.light .dlg{background:#ffffff;color:#0f172a}
  .dlg h3{margin:0 0 8px 0}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:620px){ .grid{grid-template-columns:1fr 1fr} }
  .checks{display:flex;gap:8px;flex-wrap:wrap}
  .checks label{
    display:flex;align-items:center;gap:8px;
    font-size:12px;padding:6px 10px;border-radius:999px;
    border:1px solid var(--border); background:#0e1420; color:#e9ecf1
  }
  body.light .checks label{ background:#f8fafc;color:#0f172a;border-color:#cbd5e1; }
  .checks input[type="checkbox"]{ width:auto;height:auto;margin:0;transform:scale(1.2);accent-color:#19c37d; }
  .calcRow{display:flex;justify-content:space-between;align-items:center;color:#9aa1b3;font-size:12px;margin-top:4px}

  /* Aufgaben verwalten ‚Äì Spalten */
  .manageHead{display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:6px;color:var(--muted);font-size:12px}
  .manageRow{display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:6px}
</style>
</head>
<body>
<header>
  <h1>Maschinen-Check
    <button class="btn2 right" id="themeBtn" style="float:right;margin-left:8px">üåì Modus</button>
  </h1>
  <div class="shiftInfo" id="shiftInfo"></div>
  <div class="total" id="totalTime">Gesamtzeit: 0 Min (offen)</div>

  <div class="extraLine"><span id="nextBreak" class="chip">Pause bis zur n√§chsten Arbeit: ‚Äî</span></div>
  <div class="extraLine">
    <span id="inspectionInfo" class="chip">Sichtpr√ºfung in: ‚Äî</span>
    <button class="btnYellow" id="inspectionBtn">Sichtpr√ºfung erledigt</button>
  </div>
  <div class="extraLine">
    <span id="statusCounts" class="chip">√úberf√§llig: 0 ¬∑ Bald f√§llig: 0 ¬∑ Offen: 0 ¬∑ Elektriker: 0 ¬∑ Schlosser: 0</span>
  </div>
</header>

<main>
  <button class="btn" id="addBtn">+ Maschine hinzuf√ºgen</button>
  <div class="actions" style="margin-top:8px">
    <button class="btn2" id="manageTasksBtn">‚öôÔ∏è Aufgaben verwalten</button>
  </div>

  <div class="list" id="taskList"></div>
  <button class="btn" id="pdfBtn">üìÑ PDF erstellen</button>
</main>

<!-- Dialog Maschine -->
<dialog id="taskDlg">
  <div class="dlg">
    <h3 id="dlgTitle">Maschine hinzuf√ºgen</h3>
    <div class="grid">
      <div>
        <label class="small">Maschinen-Nr.</label>
        <input id="f_nr" type="text" placeholder="z. B. 7">
      </div>
      <div>
        <!-- Max 08:00 -->
        <label class="small">Restzeit (Std:Min) ‚Äì max 08:00</label>
        <input id="f_timer" type="time" step="60" value="00:30">
      </div>
      <div style="grid-column:1 / -1">
        <label class="small">Aufgaben</label>
        <div class="checks" id="checks">
          <label><input type="checkbox" class="f_tag" value="Fachung" data-min="10"> Fachung (10)</label>
          <label><input type="checkbox" class="f_tag" value="Folie" data-min="3"> Folie (3)</label>
          <label><input type="checkbox" class="f_tag" value="Einbau" data-min="5"> Einbau (5)</label>
          <label><input type="checkbox" class="f_tag" value="Ausbau" data-min="4"> Ausbau (4)</label>
          <label><input type="checkbox" class="f_tag" value="Maschinen putzen" data-min="15"> Maschinen putzen (15)</label>
        </div>
        <div class="calcRow">
          <span>Berechnete Arbeitszeit:</span>
          <strong id="calcDur">0 Min</strong>
        </div>
      </div>
      <div>
        <label class="small">Zusatz-Minuten</label>
        <input id="f_extra" type="number" min="0" step="1" value="0">
      </div>
      <div>
        <label class="small">Notiz</label>
        <input id="f_note" type="text" placeholder="Notizen f√ºr dich selbst">
      </div>
      <div style="grid-column:1 / -1">
        <label class="small">Fehler/Grund (optional)</label>
        <select id="f_reason">
          <option value="">‚Äî</option>
          <option value="Elektriker">Elektriker gemeldet (Defekt)</option>
          <option value="Schlosser">Schlosser gemeldet (Defekt)</option>
        </select>
      </div>
    </div>
    <div class="actions" style="margin-top:6px">
      <button class="btn2" id="cancelBtn">Abbrechen</button>
      <button class="btn2" id="saveBtn">Speichern</button>
    </div>
  </div>
</dialog>

<!-- Dialog Aufgaben verwalten -->
<dialog id="manageDlg">
  <div class="dlg">
    <h3>Aufgaben verwalten</h3>
    <div class="small" style="margin-bottom:6px">
      Aufgabe links eintragen, rechts Minuten <strong>1‚Äì60</strong> ausw√§hlen.
    </div>

    <div class="manageHead">
      <div>Aufgabe</div>
      <div>Minuten</div>
    </div>
    <div id="taskRows"></div>

    <div class="actions" style="margin-top:8px">
      <button class="btn2" id="addTaskTypeBtn">+ Aufgabe</button>
      <button class="btn2" id="resetTaskTypesBtn">‚Ü∫ Standard</button>
      <button class="btn2" id="closeManageBtn">Schlie√üen</button>
      <button class="btn2" id="saveManageBtn">Speichern</button>
    </div>
  </div>
</dialog>

<!-- Dialog: Grund setzen (Schnellfunktion mit Buttons) -->
<dialog id="reasonDlg">
  <div class="dlg">
    <h3>Grund setzen</h3>
    <div class="actions" style="margin-top:4px">
      <button class="btn2" id="reasonEle">Elektriker</button>
      <button class="btn2" id="reasonSch">Schlosser</button>
      <button class="btn2" id="reasonClear">Entfernen</button>
      <button class="btn2" id="reasonCancel">Abbrechen</button>
    </div>
  </div>
</dialog>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* === Konstante Einstellungen === */
const ORANGE_THRESHOLD_MIN = 45;
const MAX_TIMER_MIN = 8*60;                     // Max 8h
const INSPECTION_INTERVAL_MIN = 120;
const KEY = "maschinenCheck_v1plus";
const KEY_TASKTYPES = "maschinenCheck_taskTypes_v1";
const KEY_INSPECTION = "maschinenCheck_inspectionLastAt_v1";
const KEY_THEME = "maschinenCheck_theme_v1";

/* === Daten === */
let tasks = JSON.parse(localStorage.getItem(KEY) || "[]");

/* === Utils === */
const $ = s => document.querySelector(s);
const $$ = (s,root=document) => Array.from(root.querySelectorAll(s));
function save(){ localStorage.setItem(KEY, JSON.stringify(tasks)); }
function fmtCountdown(ms){
  if (ms <= 0) return "00:00";
  const totalMin = Math.floor(ms/60000);
  const h = Math.floor(totalMin/60);
  const m = totalMin%60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}
function fmtTime(ts){
  const d = new Date(ts);
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function timeToMinutes(val){
  if(!val || !val.includes(":")) return 0;
  const [h,m] = val.split(":").map(n=>parseInt(n,10));
  return clamp(h*60+m, 0, MAX_TIMER_MIN);
}
function statusFor(t){
  if (t.done) return "green";
  const left = t.due - Date.now();
  if (t.reason === "Elektriker" || t.reason === "Schlosser") return "paused"; // Sonderstatus
  if (left <= 0) return "red";
  if (left <= ORANGE_THRESHOLD_MIN*60000) return "orange";
  return "blue";
}
function sortTasks(a,b){
  const now = Date.now();
  const aOver = (!a.done && a.due <= now), bOver = (!b.done && b.due <= now);
  if (aOver && !bOver) return -1;
  if (!aOver && bOver) return 1;
  if (!a.done && b.done) return -1;
  if (a.done && !b.done) return 1;
  return Math.max(0,a.due-now) - Math.max(0,b.due-now);
}

/* === Theme === */
(function initTheme(){
  const t = localStorage.getItem(KEY_THEME);
  if(t === "light") document.body.classList.add("light");
})();
$("#themeBtn").addEventListener("click", ()=>{
  document.body.classList.toggle("light");
  localStorage.setItem(KEY_THEME, document.body.classList.contains("light") ? "light" : "dark");
});

/* === Aufgaben-Typen === */
const DEFAULT_TASK_TYPES = [
  {label:"Fachung", minutes:10},
  {label:"Folie", minutes:3},
  {label:"Einbau", minutes:5},
  {label:"Ausbau", minutes:4},
  {label:"Maschinen putzen", minutes:15},
];
function loadTaskTypes(){
  try{ return JSON.parse(localStorage.getItem(KEY_TASKTYPES)) || DEFAULT_TASK_TYPES.slice(); }
  catch(e){ return DEFAULT_TASK_TYPES.slice(); }
}
function saveTaskTypes(list){ localStorage.setItem(KEY_TASKTYPES, JSON.stringify(list)); }
function rebuildChecksFromTypes(){
  const types = loadTaskTypes();
  const wrap = $("#checks");
  wrap.innerHTML = ""; // Element bleibt, nur Inhalt neu
  types.forEach(t=>{
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" class="f_tag" value="${t.label}" data-min="${t.minutes}"> ${t.label} (${t.minutes})`;
    wrap.appendChild(label);
  });
}
rebuildChecksFromTypes();

/* === Sichtpr√ºfung === */
function getLastInspection(){ return parseInt(localStorage.getItem(KEY_INSPECTION)||"0",10) || 0; }
function setLastInspection(ts){ localStorage.setItem(KEY_INSPECTION, String(ts)); }
if(!getLastInspection()){ setLastInspection(Date.now()); }
$("#inspectionBtn").addEventListener("click", ()=>{
  setLastInspection(Date.now());
  render();
});

/* === Reason Dialog (Schnellfunktion) === */
let reasonTargetId = null;
const reasonDlg = $("#reasonDlg");
$("#reasonEle").addEventListener("click", ()=> applyReasonToTarget("Elektriker"));
$("#reasonSch").addEventListener("click", ()=> applyReasonToTarget("Schlosser"));
$("#reasonClear").addEventListener("click", ()=> applyReasonToTarget(""));
$("#reasonCancel").addEventListener("click", ()=> reasonDlg.close());

function openReasonDialog(id){
  reasonTargetId = id;
  reasonDlg.showModal();
}
function applyReasonToTarget(val){
  if(reasonTargetId==null){ reasonDlg.close(); return; }
  const t = tasks.find(x=>x.id===reasonTargetId);
  if(t){
    t.reason = (val||"").trim();
    save(); render();
  }
  reasonTargetId = null;
  reasonDlg.close();
}

/* === Render === */
function render(){
  const list = tasks.slice().sort(sortTasks);
  const total = list.filter(t=>!t.done).reduce((s,t)=> s + (parseInt(t.duration,10)||0), 0);
  $("#totalTime").textContent = `Gesamtzeit: ${total} Min (offen)`;
  $("#shiftInfo").textContent = getShiftInfo();

  // Pause bis zur n√§chsten Arbeit
  const now = Date.now();
  const open = list.filter(t=>!t.done);
  const nextMs = open.map(t=>t.due - now).filter(ms=>ms>0).sort((a,b)=>a-b)[0];
  let pauseTxt = "‚Äî";
  if(open.length === 0) pauseTxt = "‚Äî (keine anstehende Arbeit)";
  else if(nextMs === undefined){
    const anyOver = open.some(t=>t.due <= now);
    pauseTxt = anyOver ? "00:00 (sofort)" : "‚Äî";
  }else{
    pauseTxt = fmtCountdown(nextMs);
  }
  $("#nextBreak").textContent = `Pause bis zur n√§chsten Arbeit: ${pauseTxt}`;

  // Sichtpr√ºfung
  const last = getLastInspection();
  const dueIn = INSPECTION_INTERVAL_MIN*60000 - (now - last);
  $("#inspectionInfo").textContent = dueIn>0
    ? `Sichtpr√ºfung in: ${fmtCountdown(dueIn)}`
    : `Sichtpr√ºfung f√§llig!`;

  // Z√§hler (Elektriker/Schlosser separat)
  const overCount = open.filter(t=>t.due <= now && !t.reason).length; // Pausen mit Grund nicht als √ºberf√§llig
  const soonCount = open.filter(t=>t.due > now && (t.due - now) <= ORANGE_THRESHOLD_MIN*60000 && !t.reason).length;
  const openCount = open.length;
  const eleCount = open.filter(t=>t.reason === "Elektriker").length;
  const schCount = open.filter(t=>t.reason === "Schlosser").length;
  $("#statusCounts").textContent = `√úberf√§llig: ${overCount} ¬∑ Bald f√§llig: ${soonCount} ¬∑ Offen: ${openCount} ¬∑ Elektriker: ${eleCount} ¬∑ Schlosser: ${schCount}`;

  // Karten
  const box = $("#taskList");
  box.innerHTML = "";
  list.forEach(t=>{
    const msLeft = t.due - now;
    const status = statusFor(t);
    const tags = (t.tags||[]).map(x=>`<span class="tag">${x}</span>`).join("");
    const reasonTag = t.reason ? `<span class="tag">Grund: ${t.reason}</span>` : "";
    const div = document.createElement("div");
    div.className = `task ${status}`;
    if(status === "red") div.classList.add("blink");
    if(status === "paused") div.classList.add("paused");

    // Fortschritt
    const totalMinInit = parseInt(t.totalMin || 0, 10);
    let progressPct = 0;
    if(totalMinInit > 0){
      const gone = clamp(totalMinInit*60000 - Math.max(0, msLeft), 0, totalMinInit*60000);
      progressPct = Math.round((gone / (totalMinInit*60000)) * 100);
    }

    const dueTimeTxt = fmtTime(t.due);

    div.innerHTML = `
      <div class="row">
        <strong>Maschine ${t.nr}</strong>
        <span class="pill">${fmtCountdown(Math.max(0,msLeft))} ¬∑ f√§llig um ${dueTimeTxt}</span>
      </div>
      <div class="tags">${tags}${reasonTag}</div>
      <div class="row" style="margin-top:6px">
        <span class="note">${t.note||""}</span>
        <span class="small">Arbeitszeit: ${t.duration||0} Min</span>
      </div>

      <div class="progress"><span style="width:${progressPct}%;"></span></div>

      <div class="actions">
        <button class="btn2" onclick="adjTime(${t.id}, -5)">‚àí5 Min</button>
        <button class="btn2" onclick="adjTime(${t.id}, +5)">+5 Min</button>

        <button class="btn2" onclick="toggleDone(${t.id})">${t.done ? "Wieder offen" : "Erledigt"}</button>
        <button class="btn2" onclick="editTask(${t.id})">Bearbeiten</button>
        <button class="btn2" onclick="openReasonDialog(${t.id})">Grund setzen</button>
        <button class="btn2 danger" onclick="deleteTask(${t.id})">L√∂schen</button>
      </div>
    `;
    box.appendChild(div);
  });
}

/* === Schichtinfo === */
function getShiftInfo(){
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const min = h*60 + m;
  if(min >= 330 && min < 810) return "Fr√ºhschicht 05:30-13:30";
  if(min >= 810 && min < 1290) return "Sp√§tschicht 13:30-21:30";
  return "Nachtschicht 21:30-05:30";
}

/* === CRUD & Dialoge === */
function addTask(){ openDialog(); }
function editTask(id){
  const t = tasks.find(x=>x.id===id); if(!t) return;
  openDialog(t);
}
function deleteTask(id){
  if(!confirm("Eintrag l√∂schen?")) return;
  tasks = tasks.filter(t=>t.id!==id); save(); render();
}
function toggleDone(id){
  const t = tasks.find(x=>x.id===id); if(!t) return;
  t.done = !t.done; save(); render();
}

/* Schnellaktionen Zeit */
function adjTime(id, deltaMin){
  const t = tasks.find(x=>x.id===id); if(!t || t.done) return;
  t.due += deltaMin*60000;
  t.totalMin = clamp((t.totalMin||0) + deltaMin, 0, MAX_TIMER_MIN);
  save(); render();
}

const dlg = $("#taskDlg");
$("#addBtn").addEventListener("click", addTask);
$("#cancelBtn").addEventListener("click", ()=> dlg.close());
$("#saveBtn").addEventListener("click", saveFromDialog);

/* Dialog: Aufgaben verwalten ‚Äì Name + Minuten-Select 1‚Äì60 */
const manageDlg = $("#manageDlg");
$("#manageTasksBtn").addEventListener("click", ()=>{
  buildManageRows();
  manageDlg.showModal();
});
$("#closeManageBtn").addEventListener("click", ()=> manageDlg.close());
$("#resetTaskTypesBtn").addEventListener("click", ()=>{
  saveTaskTypes(DEFAULT_TASK_TYPES.slice());
  buildManageRows(); rebuildChecksFromTypes();
});
function minuteSelectHTML(value){
  const v = parseInt(value,10) || 5;
  let opts = "";
  for(let i=1;i<=60;i++){
    opts += `<option value="${i}" ${i===v?'selected':''}>${i}</option>`;
  }
  return `<select class="mt_minutes_select">${opts}</select>`;
}
$("#addTaskTypeBtn").addEventListener("click", ()=>{
  const box = $("#taskRows");
  const row = document.createElement("div");
  row.className = "manageRow";
  row.innerHTML = `
    <div><input type="text" placeholder="Bezeichnung" class="mt_label"></div>
    <div>${minuteSelectHTML(5)}</div>
  `;
  box.appendChild(row);
});
$("#saveManageBtn").addEventListener("click", ()=>{
  const labels = $$(".mt_label", manageDlg).map(i=>i.value.trim());
  const mins   = $$(".mt_minutes_select", manageDlg).map(i=>parseInt(i.value,10)||0);
  const merged = [];
  for(let i=0;i<labels.length;i++){
    if(labels[i] && mins[i]>0){ merged.push({label:labels[i], minutes:mins[i]}); }
  }
  if(merged.length===0){ alert("Bitte mindestens eine g√ºltige Aufgabe anlegen."); return; }
  saveTaskTypes(merged);
  rebuildChecksFromTypes();
  manageDlg.close();
});
function buildManageRows(){
  const box = $("#taskRows"); box.innerHTML = "";
  const types = loadTaskTypes();
  types.forEach(t=>{
    const row = document.createElement("div");
    row.className = "manageRow";
    row.innerHTML = `
      <div><input type="text" value="${t.label}" class="mt_label"></div>
      <div>${minuteSelectHTML(t.minutes)}</div>
    `;
    box.appendChild(row);
  });
}

/* Formular-Logik */
function updateCalcDur(){
  const base = $$(".f_tag:checked").reduce((s,el)=> s + (parseInt(el.dataset.min,10)||0), 0);
  const extra = parseInt($("#f_extra").value,10) || 0;
  $("#calcDur").textContent = `${base + extra} Min`;
}
document.addEventListener("change", e=>{
  if(e.target.matches(".f_tag")) updateCalcDur();
});
$("#f_extra").addEventListener("input", updateCalcDur);

let editId = null;
function openDialog(t=null){
  editId = t?.id ?? null;
  $("#dlgTitle").textContent = t ? "Maschine bearbeiten" : "Maschine hinzuf√ºgen";
  $("#f_nr").value   = t?.nr   ?? "";
  $("#f_note").value = t?.note ?? "";
  $("#f_extra").value = 0;

  // Aufgaben-Checks aus Typen neu aufbauen, dann Werte setzen
  rebuildChecksFromTypes();

  $$(".f_tag").forEach(cb=> cb.checked = !!(t?.tags||[]).includes(cb.value));
  if(t){
    const leftMin = Math.max(0, Math.floor((t.due - Date.now())/60000));
    const h = Math.floor(leftMin/60), m = leftMin%60;
    $("#f_timer").value = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
    $("#f_reason").value = t.reason || "";
  } else {
    $("#f_timer").value = "00:30";
    $("#f_reason").value = "";
  }
  updateCalcDur();
  dlg.showModal();
}
function saveFromDialog(){
  const nr   = $("#f_nr").value.trim();
  const note = $("#f_note").value.trim();
  const timerMin = timeToMinutes($("#f_timer").value);
  const tagMins  = $$(".f_tag:checked").reduce((s,el)=> s + (parseInt(el.dataset.min,10)||0), 0);
  const extra    = parseInt($("#f_extra").value,10) || 0;
  const duration = tagMins + extra;
  const tags     = $$(".f_tag:checked").map(el=>el.value);
  const reason   = ($("#f_reason").value || "").trim();

  if(!nr){ alert("Bitte Maschinen-Nr. angeben."); return; }
  const due = Date.now() + timerMin*60000;

  if(editId){
    const t = tasks.find(x=>x.id===editId);
    if(t){
      t.nr = nr; t.note = note; t.duration = duration; t.due = due; t.tags = tags; t.reason = reason;
      t.totalMin = timerMin; // f√ºr Fortschritt
    }
  } else {
    tasks.push({ id: Date.now(), nr, note, duration, due, done:false, tags, reason, totalMin: timerMin });
  }
  save(); render(); dlg.close();
}

/* PDF */
$("#pdfBtn").addEventListener("click", ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("Maschinen-Check Bericht", 10, 10);
  let y = 20;
  tasks.filter(t=>t.done).forEach(t=>{
    doc.text(`Maschine ${t.nr} - ${t.tags.join(", ")} - ${t.duration} Min`, 10, y);
    y += 8;
  });
  doc.save("maschinen_bericht.pdf");
});

/* Start */
render();
setInterval(render, 1000);

/* Schichtinfo */
function getShiftInfo(){
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const min = h*60 + m;
  if(min >= 330 && min < 810) return "Fr√ºhschicht 05:30-13:30";
  if(min >= 810 && min < 1290) return "Sp√§tschicht 13:30-21:30";
  return "Nachtschicht 21:30-05:30";
}
</script>
</body>
</html>
