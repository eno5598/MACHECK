<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Maschinen Check V2</title>
<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    header { background: #333; color: white; padding: 10px; text-align: center; }
    .container { padding: 15px; }
    button { padding: 8px 12px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
    .blue { background: #3498db; color: white; }
    .orange { background: #f39c12; color: white; }
    .red { background: #e74c3c; color: white; }
    .green { background: #2ecc71; color: white; }
    .machine { padding: 10px; margin-bottom: 10px; background: white; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    .pause-info { margin-top: 10px; padding: 10px; background: #ddd; border-radius: 5px; }
    .stopwatch { margin-top: 15px; padding: 10px; background: #ccc; border-radius: 5px; }
</style>
</head>
<body>

<header>
    <h2 id="shiftName">Schicht: wird erkannt...</h2>
</header>

<div class="container">
    <button class="blue" onclick="addMachine()">+ Maschine hinzufügen</button>
    <div id="machines"></div>

    <div class="pause-info" id="pauseInfo">Pause-Info wird berechnet...</div>

    <div class="stopwatch">
        <h3>Fachung-Wechsel Zeit messen</h3>
        <div id="stopwatchTime">00:00</div>
        <button class="blue" onclick="startStopwatch()">Start</button>
        <button class="orange" onclick="stopStopwatch()">Stop</button>
        <button class="red" onclick="resetStopwatch()">Reset</button>
        <div id="lastTime"></div>
        <div id="averageTime"></div>
    </div>
</div>

<script>
let machines = JSON.parse(localStorage.getItem("machines")) || [];
let stopwatchInterval, stopwatchSeconds = 0, times = [];

function detectShift() {
    let now = new Date();
    let h = now.getHours(), m = now.getMinutes();
    let current = h * 60 + m;
    let shift = "";
    if (current >= 330 && current < 810) shift = "Frühschicht (05:30 - 13:30)";
    else if (current >= 810 && current < 1290) shift = "Spätschicht (13:30 - 21:30)";
    else shift = "Nachtschicht (21:30 - 05:30)";
    document.getElementById("shiftName").innerText = "Schicht: " + shift;
}

function addMachine() {
    let name = prompt("Maschinen-Nummer / Name:");
    let minutes = parseInt(prompt("Zeit bis fällig (in Minuten):"));
    if (!name || isNaN(minutes)) return;
    let due = Date.now() + minutes * 60000;
    machines.push({ name, due, done: false });
    saveMachines();
    renderMachines();
}

function toggleDone(index) {
    machines[index].done = !machines[index].done;
    saveMachines();
    renderMachines();
}

function saveMachines() {
    localStorage.setItem("machines", JSON.stringify(machines));
}

function renderMachines() {
    let container = document.getElementById("machines");
    container.innerHTML = "";
    let now = Date.now();

    machines.sort((a, b) => a.due - b.due);

    machines.forEach((m, i) => {
        let remaining = Math.max(0, Math.floor((m.due - now) / 1000));
        let mins = Math.floor(remaining / 60);
        let secs = remaining % 60;
        let color = m.done ? "green" : mins <= 0 ? "red" : mins <= 45 ? "orange" : "blue";

        let div = document.createElement("div");
        div.className = "machine " + color;
        div.innerHTML = `
            <strong>${m.name}</strong> - ${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}
            <button onclick="toggleDone(${i})">${m.done ? 'Rückgängig' : 'Erledigt'}</button>
        `;
        container.appendChild(div);
    });

    updatePauseInfo();
}

function updatePauseInfo() {
    let now = Date.now();
    let nextDue = Math.min(...machines.filter(m => !m.done).map(m => m.due));
    let freeMins = isFinite(nextDue) ? Math.floor((nextDue - now) / 60000) : 0;
    let pauseMsg = "";

    let shiftStart = new Date();
    shiftStart.setMinutes(0); shiftStart.setSeconds(0);
    let h = new Date().getHours();
    if (h >= 5 && h < 13) shiftStart.setHours(5,30);
    else if (h >= 13 && h < 21) shiftStart.setHours(13,30);
    else if (h >= 21 || h < 5) {
        if (h < 5) shiftStart.setDate(shiftStart.getDate() - 1);
        shiftStart.setHours(21,30);
    }
    let elapsedMins = Math.floor((now - shiftStart.getTime()) / 60000);
    let minsToNextCheck = 120 - (elapsedMins % 120);
    if (minsToNextCheck === 120) minsToNextCheck = 0;

    if (minsToNextCheck > 0 && minsToNextCheck < freeMins) {
        pauseMsg = `Pause möglich für ${freeMins - 10} Min (Sichtprüfung in ${minsToNextCheck} Min)`;
    } else {
        pauseMsg = `Pause möglich für ${freeMins} Min`;
    }

    document.getElementById("pauseInfo").innerText = pauseMsg;
}

function startStopwatch() {
    clearInterval(stopwatchInterval);
    stopwatchInterval = setInterval(() => {
        stopwatchSeconds++;
        updateStopwatchDisplay();
    }, 1000);
}

function stopStopwatch() {
    clearInterval(stopwatchInterval);
    times.push(stopwatchSeconds);
    let avg = Math.floor(times.reduce((a,b)=>a+b,0) / times.length);
    document.getElementById("lastTime").innerText = `Letzte Zeit: ${formatTime(stopwatchSeconds)}`;
    document.getElementById("averageTime").innerText = `Durchschnitt: ${formatTime(avg)}`;
}

function resetStopwatch() {
    clearInterval(stopwatchInterval);
    stopwatchSeconds = 0;
    updateStopwatchDisplay();
}

function updateStopwatchDisplay() {
    document.getElementById("stopwatchTime").innerText = formatTime(stopwatchSeconds);
}

function formatTime(s) {
    let mins = Math.floor(s / 60);
    let secs = s % 60;
    return String(mins).padStart(2,'0') + ":" + String(secs).padStart(2,'0');
}

setInterval(renderMachines, 1000);
detectShift();
renderMachines();
</script>

</body>
</html>
